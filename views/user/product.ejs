<%- include("navbar.ejs") %>

    <style>
        .pagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination a {
            padding: 5px 10px;
            border: 1px solid #ddd;
            text-decoration: none;
            color: #007bff;
        }

        .pagination a.active {
            background-color: #007bff;
            color: #fff;
        }

        .pagination a:hover {
            background-color: #0056b3;
            color: #fff;
        }
    </style>



    <!-- Main Content -->
    <div class="productpage_container">
        <!-- Sidebar Filters -->    
        <aside class="sidebar">
            <!-- Categories -->
            <div class="sidebar-section">
                <h3>
                    <%= translations.buttons.Categories %>
                </h3>
                <% for(category of category) { %>
                    <div class="filter-option">
                        <label>
                            <input type="checkbox" name="category" value="<%= category.category_id %>">
                            <%= lang==='mr' ? category.category_name_mr : lang==='hi' ? category.category_name_hi :
                                category.category_name_en %>
                        </label>
                    </div>
                    <% } %>
            </div>

            <!-- Brands -->
            <div class="sidebar-section">
                <h3>
                    <%= translations.buttons.brands %>
                </h3>
                <% for(brand of brands) { %>
                    <div class="filter-option">
                        <label>
                            <input type="checkbox" name="brand" value="<%= brand.brand_id %>">
                            <%= lang==='mr' ? brand.brand_name_mr : lang==='hi' ? brand.brand_name_hi :
                                brand.brand_name_en %>
                        </label>
                    </div>
                    <% } %>
            </div>  

            <!-- Apply / Clear Buttons -->
            <div class="sidebar-section">
                <button id="applyFilters" class="btn btn-primary btn-sm">Apply Filters</button>
                <button id="clearFilters" class="btn btn-secondary btn-sm">Clear Filters</button>
            </div>
        </aside>


        <!-- Main Content Area -->
        <main class="main-content">
            <div class="toolbar">
                <div class="results-count">
                    Showing <%= startCount %> - <%= endCount %> of <%= totalProducts %> products
                </div>
            </div>


            <!-- Product Grid -->
          <div class="products-grid" id="productList">
  <% if(products && products.length > 0){ %>
    <% products.forEach(function(product){ %>
      <div class="product-card">
        <div class="discount-badge"><%= product.discount %>% OFF</div>
<a href="<%= product.inWishlist 
             ? '/remove_wishlist/' + product.wishlist_id + '?lang=' + lang 
             : '/wishlist/' + product.product_id + '?lang=' + lang %>" 
   class="wishlist-icon text-decoration-none">
  <% if(product.inWishlist) { %>
    <i class="fas fa-heart text-danger"></i> 
  <% } else { %>
    <i class="far fa-heart"></i> 
  <% } %>
</a>





        <div class="image-container">
          <img src="/uploads/<%= product.main_image %>" alt="<%= product.product_name %>" class="product-image">
        </div>
        <div class="product-info">
          <a href="/product_details/<%= product.product_id %>" class="product-link text-decoration-none">
            <h3 class="product-title m-0"><%= product.product_name %></h3>
            <div class="product-brand m-0"><%= product.brand_name %></div>

            <!-- Stock Quantity -->
            <div class="stock-status text-center">
              <% if(product.stock_quantity <= 10) { %>
                <span class="text-danger"><%= translations.buttons.low_stock %></span>
              <% } else { %>
                <span class="text-success"><%= translations.buttons.in_stock %></span>
              <% } %>
            </div>

            <div class="pricing">
              <div class="current-price">₹<%= product.final_price %></div>
              <div class="old-price">₹<%= product.original_price %></div> 
              <div class="savings"><%= translations.buttons.save %> <br> ₹<%= product.discount_amount %></div>
            </div>
          </a>

          <!-- Add to cart -->
          <a href="/product_details/<%= product.product_id %>"
             class="add-to-cart-btn text-decoration-none"
             <% if(cartProductIds && cartProductIds.includes(product.product_id)) { %>
                style="pointer-events: none; opacity: 0.5;"
             <% } %>>
            <i class="fas fa-shopping-cart"></i>
            <% if(cartProductIds && cartProductIds.includes(product.product_id)) { %>
              Added
            <% } else { %>
              <%= translations.buttons.add_to_cart %>
            <% } %>
          </a>

  <div class="rating">
  <% 
    let fullStars = Math.floor(product.avg_rating);
    let halfStar = product.avg_rating % 1 >= 0.5;
    let emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
  %>

  <% for(let i=0; i<fullStars; i++){ %>
    <i class="fas fa-star text-warning"></i>
  <% } %>

  <% if(halfStar){ %>
    <i class="fas fa-star-half-alt text-warning"></i>
  <% } %>

  <% for(let i=0; i<emptyStars; i++){ %>
    <i class="far fa-star text-warning"></i>
  <% } %>

  <span>(<%= product.total_reviews %> Reviews)</span>
</div>


        </div>
      </div>
    <% }) %>
  <% } else { %>
    <div class="no-products">No products found</div>
  <% } %>
</div>

        </main>
    </div>

    <!-- Farming Animation -->
    <div class="farm-animation">
        <div class="sun"></div>
        <div class="tree tree-1">
            <div class="tree-trunk"></div>
            <div class="tree-top"></div>
        </div>
        <div class="tree tree-2">
            <div class="tree-trunk"></div>
            <div class="tree-top"></div>
        </div>
        <div class="tree tree-3">
            <div class="tree-trunk"></div>
            <div class="tree-top"></div>
        </div>
        <div class="tree tree-4">
            <div class="tree-trunk"></div>
            <div class="tree-top"></div>
        </div>
        <div class="tree tree-5">
            <div class="tree-trunk"></div>
            <div class="tree-top"></div>
        </div>
        <div class="plant plant-1">
            <div class="plant-stem"></div>
            <div class="plant-leaf leaf-1"></div>
            <div class="plant-leaf leaf-2"></div>
        </div>
        <div class="plant plant-2">
            <div class="plant-stem"></div>
            <div class="plant-leaf leaf-1"></div>
            <div class="plant-leaf leaf-2"></div>
        </div>
        <div class="plant plant-3">
            <div class="plant-stem"></div>
            <div class="plant-leaf leaf-1"></div>
            <div class="plant-leaf leaf-2"></div>
        </div>
        <div class="plant plant-4">
            <div class="plant-stem"></div>
            <div class="plant-leaf leaf-1"></div>
            <div class="plant-leaf leaf-2"></div>
        </div>
        <!-- Pagination -->
        <div class="pagination mt-4">
            <% if (totalPages> 1) { %>
                <% if (currentPage> 1) { %>
                    <a href="?page=<%= currentPage - 1 %>&search=<%= search %>">&laquo; Previous</a>
                    <% } %>

                        <% for (let i=1; i <=totalPages; i++) { %>
                            <a href="?page=<%= i %>&search=<%= search %>"
                                class="<%= currentPage === i ? 'active' : '' %>">
                                <%= i %>
                            </a>
                            <% } %>

                                <% if (currentPage < totalPages) { %>
                                    <a href="?page=<%= currentPage + 1 %>&search=<%= search %>">Next &raquo;</a>
                                    <% } %>
                                        <% } %>
        </div>

    </div>
    <!-- Image Modal -->
<div class="modal fade" id="productImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body p-0 text-center">
        <img id="modalProductImage" src="" class="img-fluid rounded" alt="Product Image">
      </div>
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
  </div>
</div>



   <script>
document.addEventListener("DOMContentLoaded", function () {
    const applyBtn = document.getElementById("applyFilters");
    const clearBtn = document.getElementById("clearFilters");

    function fetchProducts(page = 1) {
        let selectedCategories = [];
        let selectedBrands = [];

        document.querySelectorAll("input[name='category']:checked").forEach(cb => selectedCategories.push(cb.value));
        document.querySelectorAll("input[name='brand']:checked").forEach(cb => selectedBrands.push(cb.value));

        fetch("/filter-products", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ categories: selectedCategories, brands: selectedBrands, page })
        })
        .then(res => res.json())
        .then(data => {
            let productContainer = document.getElementById("productList");
            productContainer.innerHTML = "";

            if (!data.products || data.products.length === 0) {
                productContainer.innerHTML = "<div class='no-products'>No products found</div>";
                return;
            }

            data.products.forEach(product => {
                let inCart = data.cartProductIds.includes(product.product_id);
                productContainer.innerHTML += `
                <div class="product-card">
                    <div class="discount-badge">${product.discount}% OFF</div>
                    <div class="image-container">
                      <img src="/uploads/${product.main_image}" alt="${product.product_name}" class="product-image">
                    </div>
                    <div class="product-info">
                      <a href="/product_details/${product.product_id}" class="text-decoration-none">
                        <h3 class="product-title">${product.product_name}</h3>
                        <div class="product-brand">${product.brand_name}</div>
                        <div class="pricing">
                          <div class="current-price">₹${product.final_price}</div>
                          <div class="old-price">₹${product.original_price}</div>
                          <div class="savings">Save ₹${product.discount_amount}</div>
                        </div>
                      </a>
                      <a href="${inCart ? '#' : '/add_tocart?product_id='+product.product_id}" 
                         class="add-to-cart-btn text-decoration-none mt-2"
                         ${inCart ? 'style="pointer-events:none; opacity:0.5;"' : ''}>
                         <i class="fas fa-shopping-cart"></i> ${inCart ? 'Added' : 'Add to Cart'}
                      </a>
                    </div>
                </div>`;
            });

            // --- Pagination ---
            let pagination = document.querySelector(".pagination");
            pagination.innerHTML = "";
            if (data.totalPages && data.totalPages > 1) {
                if (data.currentPage > 1) {
                    pagination.innerHTML += `<a href="#" onclick="fetchProducts(${data.currentPage - 1})">&laquo; Previous</a>`;
                }
                for (let i = 1; i <= data.totalPages; i++) {
                    pagination.innerHTML += `<a href="#" class="${data.currentPage === i ? 'active' : ''}" onclick="fetchProducts(${i})">${i}</a>`;
                }
                if (data.currentPage < data.totalPages) {
                    pagination.innerHTML += `<a href="#" onclick="fetchProducts(${data.currentPage + 1})">Next &raquo;</a>`;
                }
            }
        })
        .catch(err => console.error("Error:", err));
    }

    applyBtn.addEventListener("click", () => fetchProducts());
    clearBtn.addEventListener("click", () => window.location.href = "/product?lang=<%= lang %>");
});
</script>



<script>
document.addEventListener("DOMContentLoaded", function () {
    const modalImage = document.getElementById("modalProductImage");
    const imageModal = new bootstrap.Modal(document.getElementById('productImageModal'));

    // Product images click
    document.querySelectorAll(".product-image").forEach(img => {
        img.addEventListener("click", function() {
            modalImage.src = this.src;
            imageModal.show();
        });
    });
});
</script>










    <%-include('footer') %>